name: Weekly Monitoring System

on:
  schedule:
    # Runs weekly on Mondays at 2 AM EST (7 AM UTC)
    - cron: "0 7 * * 1"
  workflow_dispatch: # Allows manual triggering

jobs:
  pubmed-monitoring:
    name: PubMed Monitoring
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run PubMed monitor
        working-directory: ./scripts
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
        run: npm run monitor
        continue-on-error: true

      - name: Upload PubMed logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pubmed-logs
          path: logs/pubmed-*.log
          retention-days: 7

  ai-analysis:
    name: AI Analysis (Optional)
    runs-on: ubuntu-latest
    needs: [pubmed-monitoring]
    if: ${{ secrets.ANTHROPIC_API_KEY != '' || secrets.OPENAI_API_KEY != '' }}  # Only run if API key exists
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run AI analysis
        working-directory: ./scripts
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER || 'anthropic' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: node ai-analyze-papers.js
        continue-on-error: true

      - name: Upload AI logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-logs
          path: logs/ai-analyze-*.log
          retention-days: 7

  recalculation:
    name: Auto-Recalculation
    runs-on: ubuntu-latest
    needs: [pubmed-monitoring, ai-analysis]
    if: always() # Run even if previous jobs failed (ai-analysis may be skipped)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: scripts/package.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Node dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run recalculation
        working-directory: ./scripts
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
        run: node auto-recalculate.js
        continue-on-error: true

      - name: Upload recalculation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: recalculation-logs
          path: logs/recalculate-*.log
          retention-days: 7

  test-completion:
    name: Test System Completion
    runs-on: ubuntu-latest
    needs: [pubmed-monitoring, ai-analysis, recalculation]
    if: always() # Run even if previous jobs failed
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run completion test
        working-directory: ./scripts
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER || 'anthropic' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || '' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || '' }}
        run: npm run test-completion
        continue-on-error: true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: logs/test-completion-*.log
          retention-days: 7

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs:
      [
        pubmed-monitoring,
        ai-analysis,
        recalculation,
        test-completion,
      ]
    if: failure()
    steps:
      - name: Check job status
        run: |
          echo "One or more monitoring jobs failed"
          echo "Check the workflow logs for details"
          # Add email/Slack notification here if needed
