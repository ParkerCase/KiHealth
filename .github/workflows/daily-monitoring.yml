name: OA Literature Mining - Weekly

on:
  schedule:
    # Runs weekly on Mondays at 2 AM EST (7 AM UTC)
    - cron: "0 7 * * 1"
  workflow_dispatch: # Allows manual triggering

jobs:
  oa-scraping:
    name: OA Literature Mining
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: pubmed-literature-mining/requirements.txt

      - name: Install dependencies
        working-directory: ./pubmed-literature-mining
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create directories
        working-directory: ./pubmed-literature-mining
        run: |
          mkdir -p data/pdfs logs

      - name: Run OA PubMed scraper
        working-directory: ./pubmed-literature-mining
        env:
          UNPAYWALL_EMAIL: parker@stroomai.com
          PUBMED_EMAIL: parker@stroomai.com
          PUBMED_TOOL: PubMedLiteratureMining
          MAX_ARTICLES_PER_RUN: 100
          RELEVANCE_THRESHOLD: 70
        run: |
          python scripts/pubmed_scraper.py
        continue-on-error: true

      - name: Analyze and notify
        working-directory: ./pubmed-literature-mining
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO_NAME: ${{ github.event.repository.name }}
          RELEVANCE_THRESHOLD: 70
        run: |
          python scripts/analyze_and_notify.py
        continue-on-error: true

      - name: Commit article data
        run: |
          git config user.name "OA Literature Monitor"
          git config user.email "actions@github.com"
          
          if [ -d pubmed-literature-mining/data/articles ]; then
            git add pubmed-literature-mining/data/articles/
            
            if ! git diff --staged --quiet; then
              git commit -m "ðŸ“š OA Literature Update - $(date +%Y-%m-%d)" || echo "No changes to commit"
              git push || echo "Nothing to push"
            fi
          fi

      - name: Generate and commit daily summary
        run: |
          git config user.name "OA Literature Monitor"
          git config user.email "actions@github.com"
          
          if [ -f pubmed-literature-mining/LATEST_FINDINGS.md ]; then
            git add pubmed-literature-mining/LATEST_FINDINGS.md
            
            if ! git diff --staged --quiet; then
              git commit -m "ðŸ“Š OA Literature Summary - $(date +%Y-%m-%d)
              
              - Articles processed: $(cat pubmed-literature-mining/logs/daily_count.txt 2>/dev/null || echo 'N/A')
              - Paywalled articles: $(cat pubmed-literature-mining/logs/paywalled_count.txt 2>/dev/null || echo 'N/A')
              - Predictive factors: $(cat pubmed-literature-mining/logs/factors_count.txt 2>/dev/null || echo 'N/A')"
              git push
            else
              echo "No changes to commit"
            fi
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oa-scraper-logs
          path: |
            pubmed-literature-mining/logs/
            pubmed-literature-mining/LATEST_FINDINGS.md
          retention-days: 7

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [oa-scraping]
    if: failure()
    steps:
      - name: Check job status
        run: |
          echo "OA Literature Mining job failed"
          echo "Check the workflow logs for details"
          # Add email/Slack notification here if needed
